<%- include("../../views/partials/user/header") %>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css" />

<style>
  .product-list-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
  }
  .product-list-header {
    margin-bottom: 20px;
  }
  .product-list-header h1 {
    font-size: 28px;
    font-weight: 600;
  }
  /* 
    Row with "FOOTWEAR FOR MEN" on the left and 
    Search bar on the right
  */
  .header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .search-group {
    display: flex;
    gap: 8px;
  }

  /* Filters bar: brand/category/price on the left, sort/apply on the right */
  .filters-bar {
    display: flex;
    justify-content: space-between;
    align-items: flex-end; /* so the Clear All can align with brand/category/price */
    flex-wrap: wrap;
    margin-bottom: 20px;
    gap: 15px;
  }
  .left-filters {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
  }
  .right-filters {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
  }
  .filter-label {
    font-size: 14px;
    margin-bottom: 5px;
    font-weight: 500;
  }
  .clear-filters {
    font-size: 14px;
    text-decoration: underline;
    cursor: pointer;
  }

  .sort-group {
    display: flex;
    flex-direction: column;
  }
  .sort-label {
    font-size: 14px;
    margin-bottom: 5px;
    font-weight: 500;
  }
  .sort-select {
    padding: 6px 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    min-width: 130px;
    font-size: 14px;
    cursor: pointer;
  }

  .apply-filters-group button {
    min-width: 110px;
  }

  /* Product grid */
  .product-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 30px;
  }
  .product-card {
    display: flex;
    flex-direction: column;
    text-align: left;
    cursor: pointer;
    position: relative;
  }
  .product-card img {
    width: 100%;
    height: 250px;
    object-fit: cover;
    margin-bottom: 10px;
  }
  .product-card .brand {
    font-size: 14px;
    color: #666;
    margin-bottom: 3px;
  }
  .product-card .name {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 3px;
    color: #333;
  }
  .product-card .price {
    font-size: 16px;
    font-weight: 600;
    color: #000;
  }

  /* Pagination */
  .pagination-container {
    display: flex;
    justify-content: center;
    margin-top: 40px;
  }
  .pagination {
    display: flex;
    list-style: none;
    gap: 8px;
  }
  .pagination li a {
    display: block;
    padding: 6px 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    color: #000;
    text-decoration: none;
    font-size: 14px;
  }
  .pagination li a.active {
    background-color: #000;
    color: #fff;
    border-color: #000;
  }

  /* Favorite button on product images */
  .product-image-container {
    position: relative;
  }
  .favorite-button {
    position: absolute;
    width: 50px;
    height: 50px;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: rgba(255, 255, 255, 0.41);
    right: 0;
    top: 0;
    border: none;
    transition: background-color 0.3s;
    cursor: pointer;
  }
  .favorite-button:hover {
    background-color: rgba(255, 255, 255, 0.6);
  }
  .favorite-button.active i {
    color: #e53e3e;
  }
  .btn-marg{
    margin-top: 25px;
  }

  /* Responsive adjustments */
  @media (max-width: 992px) {
    .product-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  @media (max-width: 768px) {
    .product-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  @media (max-width: 576px) {
    .product-grid {
      grid-template-columns: 1fr;
    }
    .filters-bar {
      flex-direction: column;
      align-items: flex-start;
    }
    .right-filters {
      align-items: flex-start;
    }
  }
</style>

<div class="product-list-container">

  <!-- Header row with heading on left, search on right -->
  <div class="product-list-header header-row">
    <h1>FOOTWEAR FOR MEN</h1>
    <div class="search-group">
      <input type="text" id="searchBar" class="form-control" placeholder="Search products" style="width: 250px;">
      <button id="searchBtn" class="btn btn-success">Search</button>
    </div>
  </div>

  <!-- Filters bar below heading -->
  <div class="filters-bar">
    <!-- Left side: brand, category, price, clear all -->
    <div class="left-filters">
      <!-- Brand Filter -->
      <div class="filter-group">
        <span class="filter-label">Brand</span>
        <select id="brandFilter" class="selectpicker" name="brand" multiple data-live-search="true" data-actions-box="true" data-none-selected-text="Brand" data-width="150px">
          <% brands.forEach(b => { %>
            <option value="<%= b.brandName %>" <%= (Array.isArray(currentBrand) ? currentBrand.includes(b.brandName) : currentBrand === b.brandName) ? 'selected' : '' %>><%= b.brandName %></option>
          <% }) %>
        </select>
      </div>

      <!-- Category Filter -->
      <div class="filter-group">
        <span class="filter-label">Category</span>
        <select id="categoryFilter" class="selectpicker" name="category" multiple data-live-search="true" data-actions-box="true" data-none-selected-text="Category" data-width="150px">
          <% categories.forEach(c => { %>
            <option value="<%= c.name %>" <%= (Array.isArray(currentCategory) ? currentCategory.includes(c.name) : currentCategory === c.name) ? 'selected' : '' %>><%= c.name %></option>
          <% }) %>
        </select>
      </div>

      <!-- Price Filter -->
      <div class="filter-group">
        <span class="filter-label">Price</span>
        <select id="priceFilter" class="selectpicker" name="price" multiple data-live-search="true" data-actions-box="true" data-none-selected-text="Price" data-width="150px">
          <option value="0-2000" <%= (Array.isArray(currentPrice) ? currentPrice.includes('0-2000') : currentPrice === '0-2000') ? 'selected' : '' %>>0 - 2000</option>
          <option value="2001-5000" <%= (Array.isArray(currentPrice) ? currentPrice.includes('2001-5000') : currentPrice === '2001-5000') ? 'selected' : '' %>>2001 - 5000</option>
          <option value="5001-10000" <%= (Array.isArray(currentPrice) ? currentPrice.includes('5001-10000') : currentPrice === '5001-10000') ? 'selected' : '' %>>5001 - 10000</option>
          <option value="10001-999999" <%= (Array.isArray(currentPrice) ? currentPrice.includes('10001-999999') : currentPrice === '10001-999999') ? 'selected' : '' %>>10000+</option>
        </select>
      </div>

      <!-- Clear Filters -->
      <div class="clear-filters" id="clearFilters">X Clear All</div>
    </div>

    <!-- Right side: sort dropdown + Apply Filters button -->
    <div class="right-filters">
      <div class="sort-group">
        <span class="sort-label">Sort by</span>
        <select class="sort-select" id="sortBy" name="sortBy">
          <option value="featured" <%= currentSort === 'featured' ? 'selected' : '' %>>Featured</option>
          <option value="priceLow" <%= currentSort === 'priceLow' ? 'selected' : '' %>>Price: Low to High</option>
          <option value="priceHigh" <%= currentSort === 'priceHigh' ? 'selected' : '' %>>Price: High to Low</option>
          <option value="az" <%= currentSort === 'az' ? 'selected' : '' %>>A - Z</option>
          <option value="za" <%= currentSort === 'za' ? 'selected' : '' %>>Z - A</option>
          <option value="newArrivals" <%= currentSort === 'newArrivals' ? 'selected' : '' %>>New Arrivals</option>
          <option value="popularity" <%= currentSort === 'popularity' ? 'selected' : '' %>>Popularity</option>
        </select>
      </div>
      <div class="apply-filters-group">
        <button id="applyFilters" class="btn btn-primary btn-marg">Apply Filters</button>
      </div>
    </div>
  </div>

  <!-- Product Grid -->
  <div class="product-grid">
    <% if (products && products.length > 0) { %>
      <% products.forEach(product => { %>
        <div class="product-card" onclick="location.href='/product/<%= product._id %>'">
          <div class="product-image-container">
            <img 
              src="/uploads/product-images/<%= product.productImage && product.productImage.length ? product.productImage[0] : 'placeholder.jpg' %>" 
              alt="<%= product.productName %>"
            >
            <button class="favorite-button" data-favorite="false" onclick="event.stopPropagation();">
              <i class="ti ti-heart"></i>
            </button>
          </div>
          <div class="brand"><%= product.brand %></div>
          <div class="name"><%= product.productName %></div>
          <div class="price">â‚¹<%= product.salePrice.toLocaleString('en-IN') %></div>
        </div>
      <% }) %>
    <% } else { %>
      <p>No products found.</p>
    <% } %>
  </div>

  <!-- Pagination -->
  <div class="pagination-container">
    <ul class="pagination">
      <% for (let i = 1; i <= totalPages; i++) { %>
        <li>
          <a href="?page=<%= i %>
            <% if (currentBrand) { %>&brand=<%= currentBrand %><% } %>
            <% if (currentCategory) { %>&category=<%= currentCategory %><% } %>
            <% if (currentPrice) { %>&price=<%= currentPrice %><% } %>
            <% if (currentSort) { %>&sortBy=<%= currentSort %><% } %>"
            class="<%= i === currentPage ? 'active' : '' %>">
            <%= i %>
          </a>
        </li>
      <% } %>
    </ul>
  </div>
</div>

<!-- Load jQuery, Bootstrap JS, then Bootstrap Select JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>

<script>
  $(function() {
    $('.selectpicker').selectpicker();
  });
  document.addEventListener('DOMContentLoaded', function(){
    const brandFilter = document.getElementById('brandFilter');
    const categoryFilter = document.getElementById('categoryFilter');
    const priceFilter = document.getElementById('priceFilter');
    const sortBy = document.getElementById('sortBy');
    const searchBar = document.getElementById('searchBar');
    const searchBtn = document.getElementById('searchBtn');
    const clearBtn = document.getElementById('clearFilters');
    const applyBtn = document.getElementById('applyFilters');

    function applyFilters(){
      let url = '?page=1';
      
      // Gather selected brands
      let selectedBrands = Array.from(brandFilter.selectedOptions).map(opt => opt.value).filter(v => v);
      selectedBrands.forEach(b => { url += '&brand=' + encodeURIComponent(b); });
      
      // Gather selected categories
      let selectedCategories = Array.from(categoryFilter.selectedOptions).map(opt => opt.value).filter(v => v);
      selectedCategories.forEach(c => { url += '&category=' + encodeURIComponent(c); });
      
      // Gather selected price ranges
      let selectedPrices = Array.from(priceFilter.selectedOptions).map(opt => opt.value).filter(v => v);
      selectedPrices.forEach(p => { url += '&price=' + encodeURIComponent(p); });
      
      // Add search query if provided
      let searchQuery = searchBar.value.trim();
      if(searchQuery){
        url += '&search=' + encodeURIComponent(searchQuery);
      }
      
      // Sort
      if(sortBy.value) {
        url += '&sortBy=' + encodeURIComponent(sortBy.value);
      }
      
      // Navigate
      window.location.replace(url);
    }

    // "Apply Filters" button triggers applyFilters
    applyBtn.addEventListener('click', applyFilters);

    // "Search" button also triggers the same filter logic
    searchBtn.addEventListener('click', applyFilters);

    // Clear all
    clearBtn.addEventListener('click', function(){
      window.location.replace('/products?page=1');
    });
  });
</script>

<%- include("../../views/partials/user/footer") %>
